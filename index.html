<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WE - High Definition Edition</title>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #fdfdf0; 
            font-family: "Microsoft YaHei", sans-serif;
            touch-action: manipulation;
        }

        .container {
            position: relative; width: 100vw; height: 100vh;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-start;
        }

        /* 桌面端恢复横向布局 */
        @media (min-width: 769px) {
            .container { flex-direction: row; }
            .content-left { width: 45%; padding-left: 8%; text-align: left; margin-top: 0; }
        }

        .content-left {
            width: 90%; margin-top: 10%; z-index: 10; pointer-events: none;
            text-align: center;
        }
        .content-left h1 { font-size: 1.8rem; color: #333; margin-bottom: 10px; }
        .content-left p {
            font-size: 0.95rem; color: #555; line-height: 2; margin: 0;
            letter-spacing: 1px; opacity: 0; animation: fadeIn 2s ease forwards;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 画布基础 CSS 保持 100% */
        #treeCanvas { position: absolute; top: 0; left: 0; z-index: 5; width: 100%; height: 100%; }

        .horizon {
            position: absolute; bottom: 15%; left: 0; right: 0;
            height: 2px; background-color: #333; z-index: 2;
        }

        .ground-petal {
            position: absolute; z-index: 6; cursor: pointer;
            transition: top 0.5s ease, transform 0.5s ease;
            transform-origin: center bottom;
        }

        .modal {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 2000;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 20px; border-radius: 20px; text-align: center;
            width: 80%; max-width: 340px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .modal.active { display: block; animation: zoom 0.3s ease; }
        .modal img { width: 100%; border-radius: 12px; border: 3px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .modal p { color: #333; margin-top: 15px; font-weight: bold; }
        
        @keyframes zoom { from { transform: translate(-50%, -50%) scale(0.9); opacity: 0; } }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1999; }
    </style>
</head>
<body>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="modal">
        <img id="mImg" src="" alt="Memory">
        <p id="mTitle"></p>
    </div>

    <div class="container" id="mainContainer">
        <div class="content-left">
            <h1>Hello, 陌生人。</h1>
            <p>纪念我们第一次跨年</p>
            <p>祝我们永远如初</p>
            <p>祝我们永远幸福</p>
            <p>像第一次见你那样</p>
            <p>以后都是我们</p>
        </div>
        <div class="horizon"></div>
        <canvas id="treeCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('treeCanvas');
        const ctx = canvas.getContext('2d');
        const modal = document.getElementById('modal');
        const overlay = document.getElementById('overlay');
        const mImg = document.getElementById('mImg');
        const mTitle = document.getElementById('mTitle');
        
        let width, height, treeX, treeY, treeScale, dpr;
        let staticLeaves = [], fallingLeaves = [], groundHeightMap = [];
        
        const photoGallery = [
            { url: '1.jpg', title: '第一次跨年' },
            { url: '4.jpg', title: '最美的你' },
            { url: '3.jpg', title: '最可爱的也是你' },
            { url: '2.jpg', title: '幸福的我们' },
            { url: '5.jpg', title: '真的好幸福' }
        ];
        
        const colorPalette = [
            { fill: '#ff69b4', stroke: '#ff1493' }, { fill: '#ffb6c1', stroke: '#ff85a1' }, 
            { fill: '#ff4500', stroke: '#d13400' }, { fill: '#ffd700', stroke: '#ffcc00' }
        ];

        function resize() {
            dpr = window.devicePixelRatio || 1;
            width = window.innerWidth;
            height = window.innerHeight;

            // --- 高清适配逻辑 ---
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            ctx.scale(dpr, dpr); 

            groundHeightMap = new Array(Math.ceil(width)).fill(0);
            
            if (width > 768) {
                treeX = width * 0.7; treeY = height * 0.8;
                treeScale = Math.max(width / 1300, 0.8);
            } else {
                treeX = width * 0.5; treeY = height * 0.85;
                treeScale = Math.max(width / 750, 0.45); // 进一步缩小手机端的树
            }
            
            generateStaticLeaves();
        }

        function generateStaticLeaves() {
            staticLeaves = [];
            const count = width > 768 ? 1600 : 700;
            for (let i = 0; i < count; i++) {
                const t = Math.random() * Math.PI * 2;
                const r = Math.pow(Math.random(), 0.5) * (240 * treeScale); 
                const lx = treeX + 16 * Math.pow(Math.sin(t), 3) * (r / 15);
                const ly = (treeY - 330 * treeScale) - (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * (r / 15);
                
                if (ly < treeY - 110 * treeScale) {
                    staticLeaves.push({ 
                        x: lx, y: ly, size: (Math.random() * 8 + 4) * treeScale, 
                        colors: colorPalette[Math.floor(Math.random() * colorPalette.length)], 
                        angle: Math.random() * Math.PI, swing: Math.random() * Math.PI * 2 
                    });
                }
            }
        }

        function drawTrunk() {
            ctx.fillStyle = '#1a1a1a';
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineCap = 'round';
            const bW = 18 * treeScale, bH = 190 * treeScale;

            ctx.beginPath();
            ctx.moveTo(treeX - bW, treeY);
            ctx.quadraticCurveTo(treeX, treeY - bH/2, treeX - bW/4, treeY - bH); 
            ctx.lineTo(treeX + bW/4, treeY - bH); 
            ctx.quadraticCurveTo(treeX + bW/2, treeY - bH/2, treeX + bW*1.5, treeY); 
            ctx.fill();

            ctx.lineWidth = 5 * treeScale;
            [[treeX, treeY-130*treeScale, treeX-70*treeScale, treeY-240*treeScale],
             [treeX, treeY-120*treeScale, treeX+80*treeScale, treeY-230*treeScale]].forEach(b => {
                ctx.beginPath(); ctx.moveTo(b[0], b[1]);
                ctx.quadraticCurveTo(b[0] + (b[2]-b[0])/2, b[1]-30*treeScale, b[2], b[3]);
                ctx.stroke();
            });
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            const time = Date.now() * 0.0008;
            drawTrunk();

            staticLeaves.forEach(l => {
                const s = Math.sin(time + l.swing) * 1.5;
                drawHeart(l.x + s, l.y + s, l.size, l.colors, 0.85, l.angle);

                if (photosToDrop.length > 0 && Math.random() > 0.997) { 
                    const data = photosToDrop.shift();
                    fallingLeaves.push({
                        x: l.x, y: l.y, size: l.size, colors: l.colors,
                        angle: l.angle, vx: (Math.random() * 0.8 - 0.4), vy: 1.5, 
                        phase: Math.random() * Math.PI * 2, memory: data 
                    });
                }
            });

            for (let i = fallingLeaves.length - 1; i >= 0; i--) {
                let p = fallingLeaves[i];
                p.vy += 0.035; p.x += p.vx + Math.sin(time * 3 + p.phase) * 0.6; p.y += p.vy; p.angle += 0.05;
                let curX = Math.floor(p.x);
                if (curX >= 0 && curX < width) {
                    let gLevel = treeY - groundHeightMap[curX];
                    if (p.y >= gLevel) {
                        if (Math.abs(p.x - treeX) < 220 * treeScale) {
                            createGroundPetal(p.x, gLevel, p.size, p.colors.fill, p.angle, p.memory);
                            for(let k=-12; k<=12; k++) if(curX+k >=0 && curX+k < width) groundHeightMap[curX+k] += 2.5 * Math.exp(-(k*k)/45);
                        }
                        fallingLeaves.splice(i, 1); continue;
                    }
                }
                drawHeart(p.x, p.y, p.size, p.colors, 0.9, p.angle);
            }
            requestAnimationFrame(animate);
        }

        function drawHeart(x, y, size, col, alpha, ang) {
            ctx.save(); ctx.translate(x, y); ctx.rotate(ang); ctx.globalAlpha = alpha;
            const g = ctx.createRadialGradient(0, 0, 0, 0, 0, size);
            g.addColorStop(0, col.fill); g.addColorStop(1, col.stroke);
            ctx.beginPath(); ctx.moveTo(0, 0);
            ctx.bezierCurveTo(-size/2, -size/2, -size, size/3, 0, size);
            ctx.bezierCurveTo(size, size/3, size/2, -size/2, 0, 0);
            ctx.fillStyle = g; ctx.fill(); ctx.restore();
        }

        function createGroundPetal(x, y, size, col, ang, mem) {
            const img = document.createElement('img');
            img.src = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="-20 -20 40 40"><path d="M0,0 C-10,-10 -20,6 0,20 C20,6 10,-10 0,0 Z" fill="${encodeURIComponent(col)}"/></svg>`;
            img.className = 'ground-petal';
            img.style.left = (x - size) + 'px'; img.style.top = (y - size + 2) + 'px'; 
            img.style.width = (size * 2) + 'px';
            img.style.transform = `rotate(${ang}rad) scale(${1.1 + Math.random()*0.2}, ${0.6 + Math.random()*0.2})`;
            img.onclick = () => { mImg.src = mem.url; mTitle.innerText = mem.title; modal.classList.add('active'); overlay.style.display = 'block'; };
            document.getElementById('mainContainer').appendChild(img);
        }

        overlay.onclick = () => { modal.classList.remove('active'); overlay.style.display = 'none'; };
        window.addEventListener('resize', () => { resize(); document.querySelectorAll('.ground-petal').forEach(el => el.remove()); });
        resize(); animate();
    </script>
</body>
</html>

